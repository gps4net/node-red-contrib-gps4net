<script type="text/javascript">
	// output metrics
	var metrics = [
		{ k: 'ins_temp', l: 'Temperature' },
		{ k: 'ins_rh', l: 'Relative humidity' },
		{ k: 'ins_io1', l: 'IO1 voltage' },
		{ k: 'ins_io2', l: 'IO2 voltage' },
		{ k: 'avg_temp', l: 'Average temperature' },
		{ k: 'avg_rh', l: 'Average relative humidity' },
		{ k: 'alm_temp', l: 'Alarm temperature' },
		{ k: 'alm_rh', l: 'Alarm relative humidity' },
		{ k: 'alm_io1', l: 'IO1 alarm voltage' },
		{ k: 'alm_io2', l: 'IO2 alarm voltage' },
		{ k: 'msg', l: 'Full message' }
	];
	// utility functions
	function exportRule(rule) {
		if (rule && rule.length) {
			let r = rule.find('input[name^="node-input-rule-"]').serializeArray();
			if (r instanceof Array && r.length > 0) {
				return r.reduce(function (a, c, i) {
					if (c.name) a[c.name.split('-').slice(3).join('_')] = c.value;
					return a;
				}, {});
			}
		}
	}
	// decode node
	RED.nodes.registerType('g4n03rht-decode', {
		category: 'GPS4NET',
		color: '#87a938',
		defaults: {
			name: {value: 'g4n03rht decode'},
			rules: {value: [{ psn: 'FFFFFFFF', metric: 'msg', }], required: true},
			outputs: {value:1}
		},
		inputs: 1,
		outputs: 1,
		icon: "logo.svg",
		outputLabels: function(id) {
			var rule = this.rules[id];
			if (rule instanceof Object) {
				let mkv = metrics.reduce(function (a, c, i) {
					a[c.k] = c.l; 
					return a;
				}, {});
				return rule.psn+': '+(mkv[rule.metric] || rule.metric);
			}
		},
		label: function() {
			return this.name || 'g4n03rht decode';
		},
		labelStyle: function() {
			return this.name ? 'node_label_italic' : '';
		},
		oneditprepare: function() {
			var node = this;
			var outputCount = $("#node-input-outputs").val('{}');
			$('#node-input-rule-container').css('min-height', '150px').css('min-width', '450px').editableList({
				addItem: function(container, i, opt) {
					if (!opt.hasOwnProperty('r')) {
						opt.r = {};
						if (i > 0) {
							let lastRule = $('#node-input-rule-container').editableList('items')[i - 1];
							var exportedRule = exportRule(lastRule);
							opt.r = exportedRule;
						}
					}
					if (!opt.hasOwnProperty('i')) opt._i = Math.floor((0x99999 - 0x10000)*Math.random()).toString();
					let row = $('<div/>', {class: 'node-input-rule-container-row'}).appendTo(container);
					$('<input/>', {
						id: 'node-input-rule-psn-'+i,
						name: 'node-input-rule-psn',
						type: 'text',
						value: opt.r.psn || '',
						style: 'width:10em; margin-right:5px;',
						placeholder: 'Sensor PSN',
					}).appendTo(row).typedInput({
						type: 'psn',
						types: [{
							value: opt.r.psn || '',
							label: 'Sensor PSN',
							icon: 'fa fa-qrcode',
							validate: RED.validators.regex(/^[A-F0-9]{8}$/),
						}],
					});
					$('<input/>', {
						id: 'node-input-rule-metric-'+i,
						name: 'node-input-rule-metric',
						value: opt.r.metric || 'msg',
						style: 'width:15em;',
					}).appendTo(row).typedInput({
						type: 'metric',
						types: [{
							value: 'msg',
							label: 'Metric',
							icon: 'fa fa-filter',
							options: metrics.map(v => ({value: v.k, label: v.l })),
						}],
					});
					$('<span/>',{style: 'margin-left: 5px;'}).appendTo(row).append(function () {
						let frag = document.createDocumentFragment();
						frag.appendChild(document.createTextNode('\u2192'));
						let spn = document.createElement('span');
						spn.className = 'node-input-rule-index';
						spn.appendChild(document.createTextNode(i+1));
						frag.appendChild(spn);
						return frag;
					});
					let currentOutputs = JSON.parse(outputCount.val() || '{}');
					currentOutputs[opt.hasOwnProperty('i') ? opt.i : opt._i] = i;
					outputCount.val(JSON.stringify(currentOutputs));
				},
				removeItem: function(opt) {
					let currentOutputs = JSON.parse(outputCount.val() || '{}');
					if (opt.hasOwnProperty('i')) {
						currentOutputs[opt.i] = -1;
					} else {
						delete currentOutputs[opt._i];
					}
					let rules = $('#node-input-rule-container').editableList('items');
					rules.each(function(i) {
						$(this).find('.node-input-rule-index').html(i+1);
						let data = $(this).data('data');
						currentOutputs[data.hasOwnProperty('i') ? data.i : data._i] = i;
					});
					outputCount.val(JSON.stringify(currentOutputs));
				},
				sortItems: function(rules) {
					let currentOutputs = JSON.parse(outputCount.val() || '{}');
					rules = $('#node-input-rule-container').editableList('items');
					rules.each(function(i) {
						$(this).find('.node-input-rule-index').html(i+1);
						let data = $(this).data('data');
						currentOutputs[data.hasOwnProperty('i') ? data.i : data._i] = i;
					});
					outputCount.val(JSON.stringify(currentOutputs));
				},
				removable: true,
				sortable: true
			});

			for (let i=0; i<this.rules.length; i++) {
				let rule = this.rules[i];
				$("#node-input-rule-container").editableList('addItem', {r: rule, i: i});
			}
		},
		oneditsave: function() {
			var node = this;
			let rules = $("#node-input-rule-container").editableList('items');
			node.rules = [];
			rules.each(function(i) {
				node.rules.push(exportRule($(this)));
			});
		},
		oneditresize: function(size) {
			let rows = $('#dialog-form>div:not(.node-input-rule-container-row)');
			let height = size.height;
			for (let i=0; i<rows.length; i++) height -= $(rows[i]).outerHeight(true);
			let editorRow = $('#dialog-form>div.node-input-rule-container-row');
			height -= (parseInt(editorRow.css('marginTop'))+parseInt(editorRow.css('marginBottom')));
			height += 16;
			$('#node-input-rule-container').editableList('height', height);
		}
	});
	// encode node
	RED.nodes.registerType('g4n03rht-encode', {
		category: 'GPS4NET',
		color: '#87a938',
		defaults: {
			name: {value: 'g4n03rht encode'},
		},
		inputs: 1,
		outputs: 1,
		icon: "logo.svg",
		label: function() {
			return this.name || 'g4n03rht encode';
		},
	});
</script>

<script type="text/html" data-template-name="g4n03rht-decode">
	<div class="form-row">
		<label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
		<input type="text" id="node-input-name" placeholder="Name"><br>
	</div>
	<div class="form-row node-input-rule-container-row">
		<input type="hidden" id="node-input-outputs"/>
		<label for="node-input-rule-container"><i class="fa fa-list"></i> <span>Rules</span></label>
		<ol id="node-input-rule-container"></ol>
	</div>
</script>

<script type="text/html" data-help-name="g4n03rht-decode">
	<p>A node that decodes CAN frames from G4N03RHT temperature and humidity
	sensors to higher level data.</p>
</script>

<script type="text/html" data-template-name="g4n03rht-encode">
	<div class="form-row">
		<label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
		<input type="text" id="node-input-name" placeholder="Name"><br>
	</div>
</script>

<script type="text/html" data-help-name="g4n03rht-encode">
	<p>A node that encodes CAN frames for programming G4N03RHT temperature
	and humidity sensors.</p>
</script>
